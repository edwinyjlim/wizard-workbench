name: Wizard CI

on:
  workflow_dispatch:
    inputs:
      app:
        description: 'Test app path (e.g., next-js/15-app-router-saas)'
        required: true
        type: string
      trigger_id:
        description: 'Trigger ID (inherited from orchestrator, auto-generated if empty)'
        required: false
        type: string
        default: ''
      evaluate:
        description: 'Run PR evaluator'
        type: boolean
        default: true
      base_branch:
        description: 'Base branch for PR'
        type: string
        default: 'main'
      wizard_ref:
        description: 'Wizard repo branch/tag/sha'
        type: string
        default: 'main'
      examples_ref:
        description: 'Examples repo branch/tag/sha'
        type: string
        default: 'main'
      posthog_ref:
        description: 'PostHog repo branch/tag/sha (for MCP)'
        type: string
        default: 'master'

permissions:
  contents: write
  pull-requests: write

jobs:
  wizard-ci:
    runs-on: ubuntu-latest
    outputs:
      pr_url: ${{ steps.run-wizard.outputs.pr_url }}
      pr_number: ${{ steps.run-wizard.outputs.pr_number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Clone and build Wizard CLI
        run: |
          echo "::group::Cloning wizard repo"
          git clone --depth 1 --branch ${{ inputs.wizard_ref }} \
            https://github.com/PostHog/wizard.git $HOME/wizard
          echo "::endgroup::"

          echo "::group::Installing wizard dependencies"
          cd $HOME/wizard
          pnpm install --frozen-lockfile
          echo "::endgroup::"

          echo "::group::Building wizard"
          pnpm build
          echo "::endgroup::"

          echo "WIZARD_PATH=$HOME/wizard" >> $GITHUB_ENV

      - name: Clone and build Examples
        run: |
          echo "::group::Cloning examples repo"
          git clone --depth 1 --branch ${{ inputs.examples_ref }} \
            https://github.com/PostHog/examples.git $HOME/examples
          echo "::endgroup::"

          echo "::group::Installing examples dependencies"
          cd $HOME/examples
          npm install
          echo "::endgroup::"

          echo "::group::Building examples MCP resources"
          npm run build:docs
          echo "::endgroup::"

          echo "EXAMPLES_PATH=$HOME/examples" >> $GITHUB_ENV

      - name: Clone PostHog monorepo and install MCP
        run: |
          echo "::group::Cloning PostHog monorepo (sparse checkout)"
          git clone --depth 1 --branch ${{ inputs.posthog_ref }} \
            --filter=blob:none --sparse \
            https://github.com/PostHog/posthog.git $HOME/posthog
          cd $HOME/posthog
          git sparse-checkout set services/mcp
          echo "::endgroup::"

          echo "::group::Installing MCP dependencies"
          cd $HOME/posthog/services/mcp/typescript
          # Use --ignore-workspace to avoid resolving all 45 workspace packages
          pnpm install --ignore-workspace --no-frozen-lockfile
          echo "::endgroup::"

          echo "MCP_PATH=$HOME/posthog/services/mcp" >> $GITHUB_ENV

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Switch remote to HTTPS for token-based auth (works in CI without SSH keys)
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

      - name: Run Wizard CI
        id: run-wizard
        run: |
          # Start MCP server in background
          cd $MCP_PATH/typescript
          pnpm dev &
          MCP_PID=$!

          # Wait for MCP server to be ready
          echo "Waiting for MCP server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8787/mcp > /dev/null 2>&1; then
              echo "MCP server is ready"
              break
            fi
            sleep 1
          done

          # Debug: check env vars are set
          echo "EVALUATOR_ANTHROPIC_API_KEY set: $([ -n \"$EVALUATOR_ANTHROPIC_API_KEY\" ] && echo 'yes' || echo 'no')"

          # Run wizard
          cd $GITHUB_WORKSPACE
          CMD="pnpm wizard-ci --app ${{ inputs.app }} --base ${{ inputs.base_branch }}"
          if [ -n "${{ inputs.trigger_id }}" ]; then
            CMD="$CMD --trigger-id ${{ inputs.trigger_id }}"
          fi
          if [ "${{ inputs.evaluate }}" = "true" ]; then
            CMD="$CMD --evaluate"
          fi
          $CMD 2>&1 | tee wizard-output.log
          WIZARD_EXIT=$?

          # Stop MCP server
          kill $MCP_PID 2>/dev/null || true

          # Extract PR URL
          PR_URL=$(grep -oP 'PR: \K(https://github.com/[^\s]+)' wizard-output.log || true)
          if [ -n "$PR_URL" ]; then
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            PR_NUM=$(echo $PR_URL | grep -oP '/pull/\K\d+')
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          fi

          exit $WIZARD_EXIT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # PR evaluator uses EVALUATOR_ANTHROPIC_API_KEY to avoid conflict with wizard
          EVALUATOR_ANTHROPIC_API_KEY: ${{ secrets.EVALUATOR_ANTHROPIC_API_KEY }}
          # Wizard CI mode requires PostHog credentials
          POSTHOG_REGION: ${{ secrets.POSTHOG_REGION }}
          POSTHOG_PERSONAL_API_KEY: ${{ secrets.POSTHOG_PERSONAL_API_KEY }}
          # Dependency paths
          WIZARD_PATH: ${{ env.WIZARD_PATH }}
          EXAMPLES_PATH: ${{ env.EXAMPLES_PATH }}
          MCP_PATH: ${{ env.MCP_PATH }}

      - name: Upload logs
        # Skip in act (local runner) - artifact upload requires GitHub infrastructure
        if: always() && !env.ACT
        uses: actions/upload-artifact@v4
        with:
          # Use app name with slashes replaced by dashes for valid artifact name
          name: wizard-ci-logs-${{ github.run_id }}-${{ inputs.app && replace(inputs.app, '/', '-') || 'unknown' }}
          path: wizard-output.log

      - name: Summary
        if: always()
        run: |
          echo "## Wizard CI Results: ${{ inputs.app }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App:** ${{ inputs.app }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.trigger_id }}" ]; then
            echo "**Trigger ID:** ${{ inputs.trigger_id }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Evaluate:** ${{ inputs.evaluate }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dependency Versions" >> $GITHUB_STEP_SUMMARY
          echo "- **wizard:** ${{ inputs.wizard_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **examples:** ${{ inputs.examples_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **mcp (posthog):** ${{ inputs.posthog_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.run-wizard.outputs.pr_url }}" ]; then
            echo "**PR:** ${{ steps.run-wizard.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          fi
