name: Wizard CI

on:
  workflow_dispatch:
    inputs:
      app:
        description: 'Test app path (e.g., next-js/15-app-router-saas) or "all"'
        required: true
        type: string
        default: ''
      evaluate:
        description: 'Run PR evaluator'
        type: boolean
        default: true
      base_branch:
        description: 'Base branch for PR'
        type: string
        default: 'main'
      wizard_ref:
        description: 'Wizard repo branch/tag/sha'
        type: string
        default: 'main'
      examples_ref:
        description: 'Examples repo branch/tag/sha'
        type: string
        default: 'main'
      posthog_ref:
        description: 'PostHog repo branch/tag/sha (for MCP)'
        type: string
        default: 'master'

permissions:
  contents: write
  pull-requests: write

jobs:
  # First job: discover available apps and validate input
  discover-apps:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.find-apps.outputs.apps }}
      app_list: ${{ steps.find-apps.outputs.app_list }}
      selected_apps: ${{ steps.select-apps.outputs.selected_apps }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find available apps
        id: find-apps
        run: |
          # Find all directories with package.json in apps/
          APPS=$(find apps -name "package.json" -not -path "*/node_modules/*" \
            | sed 's|apps/||' | sed 's|/package.json||' | sort)

          # Convert to JSON array
          APPS_JSON=$(echo "$APPS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "apps=$APPS_JSON" >> $GITHUB_OUTPUT

          # Also output as readable list
          echo "app_list<<EOF" >> $GITHUB_OUTPUT
          echo "$APPS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "Available apps:"
          echo "$APPS"

      - name: Select apps to run
        id: select-apps
        run: |
          INPUT_APP="${{ inputs.app }}"
          AVAILABLE='${{ steps.find-apps.outputs.apps }}'

          if [ -z "$INPUT_APP" ] || [ "$INPUT_APP" = "all" ]; then
            # Run all apps
            echo "selected_apps=$AVAILABLE" >> $GITHUB_OUTPUT
            echo "Running all apps"
          else
            # Validate the specified app exists
            if echo "$AVAILABLE" | jq -e --arg app "$INPUT_APP" 'index($app) != null' > /dev/null; then
              echo "selected_apps=[\"$INPUT_APP\"]" >> $GITHUB_OUTPUT
              echo "Running single app: $INPUT_APP"
            else
              echo "::error::App '$INPUT_APP' not found. Available apps:"
              echo '${{ steps.find-apps.outputs.app_list }}'
              exit 1
            fi
          fi

  # Second job: run wizard-ci on selected app(s)
  wizard-ci:
    needs: discover-apps
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.discover-apps.outputs.selected_apps) }}
    outputs:
      pr_url: ${{ steps.run-wizard.outputs.pr_url }}
      pr_number: ${{ steps.run-wizard.outputs.pr_number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Clone and build Wizard CLI
        run: |
          echo "::group::Cloning wizard repo"
          git clone --depth 1 --branch ${{ inputs.wizard_ref }} \
            https://github.com/PostHog/wizard.git $HOME/wizard
          echo "::endgroup::"

          echo "::group::Installing wizard dependencies"
          cd $HOME/wizard
          pnpm install --frozen-lockfile
          echo "::endgroup::"

          echo "::group::Building wizard"
          pnpm build
          echo "::endgroup::"

          echo "WIZARD_PATH=$HOME/wizard" >> $GITHUB_ENV

      - name: Clone and build Examples
        run: |
          echo "::group::Cloning examples repo"
          git clone --depth 1 --branch ${{ inputs.examples_ref }} \
            https://github.com/PostHog/examples.git $HOME/examples
          echo "::endgroup::"

          echo "::group::Building examples MCP resources"
          cd $HOME/examples
          node build-examples-mcp-resources.js
          echo "::endgroup::"

          echo "EXAMPLES_PATH=$HOME/examples" >> $GITHUB_ENV

      - name: Clone MCP from PostHog monorepo (sparse checkout)
        run: |
          echo "::group::Sparse cloning PostHog monorepo for MCP"
          mkdir -p $HOME/posthog
          cd $HOME/posthog
          git init
          git remote add origin https://github.com/PostHog/posthog.git
          git config core.sparseCheckout true
          echo "services/mcp" >> .git/info/sparse-checkout
          git fetch --depth 1 origin ${{ inputs.posthog_ref }}
          git checkout FETCH_HEAD
          echo "::endgroup::"

          echo "::group::Installing MCP dependencies"
          cd $HOME/posthog/services/mcp
          pnpm install --frozen-lockfile
          echo "::endgroup::"

          echo "MCP_PATH=$HOME/posthog/services/mcp" >> $GITHUB_ENV

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Start MCP server
        run: |
          cd $MCP_PATH
          # Start MCP server in background
          pnpm start &
          MCP_PID=$!
          echo "MCP_PID=$MCP_PID" >> $GITHUB_ENV
          # Wait for server to be ready
          sleep 5

      - name: Run Wizard CI
        id: run-wizard
        run: |
          CMD="pnpm wizard-ci --app ${{ matrix.app }} --base ${{ inputs.base_branch }}"
          if [ "${{ inputs.evaluate }}" = "true" ]; then
            CMD="$CMD --evaluate"
          fi
          $CMD 2>&1 | tee wizard-output.log

          # Extract PR URL
          PR_URL=$(grep -oP 'PR: \K(https://github.com/[^\s]+)' wizard-output.log || true)
          if [ -n "$PR_URL" ]; then
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            PR_NUM=$(echo $PR_URL | grep -oP '/pull/\K\d+')
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # PR evaluator uses EVALUATOR_ANTHROPIC_API_KEY to avoid conflict with wizard
          EVALUATOR_ANTHROPIC_API_KEY: ${{ secrets.EVALUATOR_ANTHROPIC_API_KEY }}
          # Wizard CI mode requires PostHog credentials
          POSTHOG_REGION: ${{ secrets.POSTHOG_REGION }}
          POSTHOG_PERSONAL_API_KEY: ${{ secrets.POSTHOG_PERSONAL_API_KEY }}
          # Dependency paths
          WIZARD_PATH: ${{ env.WIZARD_PATH }}
          EXAMPLES_PATH: ${{ env.EXAMPLES_PATH }}
          MCP_PATH: ${{ env.MCP_PATH }}

      - name: Stop MCP server
        if: always()
        run: |
          if [ -n "$MCP_PID" ]; then
            kill $MCP_PID || true
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wizard-ci-logs-${{ matrix.app }}
          path: wizard-output.log

      - name: Summary
        if: always()
        run: |
          echo "## Wizard CI Results: ${{ matrix.app }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App:** ${{ matrix.app }}" >> $GITHUB_STEP_SUMMARY
          echo "**Evaluate:** ${{ inputs.evaluate }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dependency Versions" >> $GITHUB_STEP_SUMMARY
          echo "- **wizard:** ${{ inputs.wizard_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **examples:** ${{ inputs.examples_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **mcp (posthog):** ${{ inputs.posthog_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.run-wizard.outputs.pr_url }}" ]; then
            echo "**PR:** ${{ steps.run-wizard.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          fi
